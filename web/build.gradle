plugins {
    id "com.moowork.node" version "1.2.0"
    id "com.github.hierynomus.license" version"0.14.0"
}

node {
    version = '8.5.0'
    npmVersion = '5.4.2'
    nodeModulesDir = projectDir
    download = true
}

license {
    header file("${rootDir}/LICENSE_HEADER")
    mapping {
        ts='JAVADOC_STYLE'
        proto='DOUBLESLASH_STYLE'
        interop='DOUBLESLASH_STYLE'
    }
    strictCheck true
}

task licenseFormatTS(type: com.hierynomus.gradle.license.tasks.LicenseFormat) {
    source = fileTree(dir: ".").exclude("**/node_modules/*")
            .include("**/*.ts").include("**/*.proto").include("**/*.interop")
}

tasks["license"].dependsOn licenseFormatTS
licenseFormat.dependsOn licenseFormatTS

task npmBuild(type: NpmTask, dependsOn: ['npm_install']) {

    ext.getArgs = { _ ->
        def isMyGet = System.env['BuildRunner'] != 'MyGet'
        def isWin = org.gradle.internal.os.OperatingSystem.current().isWindows()
        println isWin
        return isMyGet ? ['run', 'ci-build-all'] : (isWin ? ['run', 'build-all-win'] : ['run', 'build-all'])
    }
   
    args = getArgs() 

    doLast{
        println()
    }

}

task buildTransport(dependsOn: npmBuild) {
    outputs.dir('.')
}

task build(dependsOn: buildTransport) {
}
build.dependsOn('license')
